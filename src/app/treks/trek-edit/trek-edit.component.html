<ion-content>
  <!-- HEADER -->
  <nav class="modern-header">
    <div class="container-fluid px-4 py-3">
      <div class="d-flex align-items-center">
        <a class="btn-back" routerLink="/admin/treks/list">
          <i class="bi bi-arrow-left"></i>
        </a>
        <h1 class="header-title mb-0 ms-3">Edit Trek</h1>
      </div>
    </div>
  </nav>

  <div class="form-wrapper">
    <div class="container py-4">
      <form [formGroup]="editTrekForm">

        <!-- BASIC TREK INFO -->
        <div class="section-card">
          <div class="section-header">
            <i class="bi bi-info-circle-fill me-2"></i>
            <span>Basic Information</span>
          </div>
          <div class="section-body">
            <div class="row g-4">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Trek Name <span class="required">*</span></label>
                  <input
                    class="form-control modern-input"
                    formControlName="name"
                    placeholder="e.g., Mountain Peak Trek"
                  />
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Location <span class="required">*</span></label>
                  <input
                    class="form-control modern-input"
                    formControlName="location"
                    placeholder="e.g., Kudure Mukha"
                  />
                </div>
              </div>

              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Difficulty <span class="required">*</span></label>
                  <select class="form-select modern-select" formControlName="difficulty">
                    <option value="" selected disabled>Select Difficulty</option>
                    <option *ngFor="let d of difficulties" [value]="d">{{ d }}</option>
                  </select>
                </div>
              </div>

              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Category <span class="required">*</span></label>
                  <select class="form-select modern-select" formControlName="category">
                    <option value="" selected disabled>Select Category</option>
                    <option *ngFor="let c of categories" [value]="c">{{ c }}</option>
                  </select>
                </div>
              </div>

              <div class="col-md-4">
                <div class="form-group">
                  <label class="form-label">Fitness Level</label>
                  <select class="form-select modern-select" formControlName="fitnessLevel">
                    <option value="" selected disabled>Select Fitness Level</option>
                    <option *ngFor="let f of fitnessLevels" [value]="f">{{ f }}</option>
                  </select>
                </div>
              </div>

              <div class="col-12">
                <div class="form-group">
                  <label class="form-label">Description</label>
                  <textarea
                    class="form-control modern-textarea"
                    rows="4"
                    formControlName="description"
                    placeholder="Describe your trek experience, highlights, and what makes it special..."
                  ></textarea>
                </div>
              </div>

              <!-- HIGHLIGHTS -->
              <div class="col-12">
                <div class="highlight-section">
                  <div class="highlight-header">
                    <i class="bi bi-star-fill me-2"></i>
                    <span>Highlights</span>
                  </div>
                  <div class="highlight-body" formArrayName="highlights">
                    <div class="highlight-item" *ngFor="let h of highlights.controls; let hi = index">
                      <input
                        class="form-control"
                        [formControlName]="hi"
                        placeholder="e.g., 360° Beautiful views"
                      />
                      <button
                        class="btn-remove"
                        type="button"
                        (click)="removeHighlight(hi)"
                      >
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                    <button
                      class="btn-add-item"
                      type="button"
                      (click)="addHighlight()"
                    >
                      <i class="bi bi-plus-circle me-2"></i> Add Highlight
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- BATCHES -->
        <div class="section-card">
          <div class="section-header">
            <i class="bi bi-calendar-event-fill me-2"></i>
            <span>Batch Information</span>
          </div>
          <div class="section-body">
            <div class="batches-wrapper" formArrayName="batches">
              <div
                class="batch-card"
                *ngFor="let batch of batches.controls; let i = index"
                [formGroupName]="i"
              >
                <!-- BATCH HEADER -->
                <div class="batch-header">
                  <h3 class="batch-title">
                    <i class="bi bi-calendar3 me-2"></i>
                    Batch {{ i + 1 }}
                  </h3>
                  <button
                    type="button"
                    class="btn-delete-batch"
                    (click)="removeBatch(i)"
                    *ngIf="batches.length > 1"
                  >
                    <i class="bi bi-trash"></i> Remove
                  </button>
                </div>

                <!-- BATCH BODY -->
                <div class="batch-body">
                  <!-- DATES & BASIC INFO -->
                  <div class="row g-3 mb-4">
                    <div class="col-md-3 col-6">
                      <div class="form-group">
                        <label class="form-label">Start Date <span class="required">*</span></label>
                        <input
                          type="date"
                          class="form-control modern-input"
                          formControlName="startDate"
                        />
                      </div>
                    </div>

                    <div class="col-md-3 col-6">
                      <div class="form-group">
                        <label class="form-label">End Date <span class="required">*</span></label>
                        <input
                          type="date"
                          class="form-control modern-input"
                          formControlName="endDate"
                        />
                      </div>
                    </div>

                    <div class="col-md-2 col-6">
                      <div class="form-group">
                        <label class="form-label">Available Slots <span class="required">*</span></label>
                        <input
                          type="number"
                          class="form-control modern-input"
                          formControlName="availableSlots"
                          placeholder="20"
                        />
                      </div>
                    </div>

                    <div class="col-md-2 col-6">
                      <div class="form-group">
                        <label class="form-label">Price (₹) <span class="required">*</span></label>
                        <input
                          type="number"
                          class="form-control modern-input"
                          formControlName="price"
                          placeholder="2000"
                        />
                      </div>
                    </div>

                    <div class="col-md-2 col-6">
                      <div class="form-group">
                        <label class="form-label">Status <span class="required">*</span></label>
                        <select class="form-select modern-select" formControlName="batchStatus">
                          <option *ngFor="let s of batchStatuses" [value]="s">
                            {{ s | titlecase }}
                          </option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- ADDITIONAL INFO -->
                  <div class="row g-3 mb-4">
                    <div class="col-md-3 col-6">
                      <div class="form-group">
                        <label class="form-label">Min Age</label>
                        <input
                          type="number"
                          class="form-control modern-input"
                          formControlName="minAge"
                          placeholder="16"
                        />
                      </div>
                    </div>

                    <div class="col-md-3 col-6">
                      <div class="form-group">
                        <label class="form-label">Duration</label>
                        <input
                          class="form-control modern-input"
                          formControlName="duration"
                          placeholder="2 Days / 1 Night"
                        />
                      </div>
                    </div>

                    <div class="col-md-3 col-6">
                      <div class="form-group">
                        <label class="form-label">Min Participants</label>
                        <input
                          type="number"
                          class="form-control modern-input"
                          formControlName="minParticipants"
                          placeholder="10"
                        />
                      </div>
                    </div>

                    <div class="col-md-3 col-6">
                      <div class="form-group">
                        <label class="form-label">Max Participants</label>
                        <input
                          type="number"
                          class="form-control modern-input"
                          formControlName="maxParticipants"
                          placeholder="25"
                        />
                      </div>
                    </div>
                  </div>

                  <!-- INCLUSIONS / EXCLUSIONS -->
                  <div class="row g-4 mb-4">
                    <!-- INCLUSIONS -->
                    <div class="col-md-6">
                      <div class="inclusions-card">
                        <div class="inc-exc-header inclusions-header">
                          <i class="bi bi-check-circle-fill me-2"></i>
                          <span>Inclusions</span>
                        </div>
                        <div class="inc-exc-body" formArrayName="inclusions">
                          <div
                            class="inc-exc-item"
                            *ngFor="let inc of getInclusions(i).controls; let ii = index"
                          >
                            <input
                              class="form-control"
                              [formControlName]="ii"
                              placeholder="e.g., Professional guide"
                            />
                            <button
                              class="btn-remove-small"
                              type="button"
                              (click)="removeInclusion(i, ii)"
                            >
                              <i class="bi bi-x-lg"></i>
                            </button>
                          </div>
                          <button
                            class="btn-add-inc-exc"
                            type="button"
                            (click)="addInclusion(i)"
                          >
                            <i class="bi bi-plus me-1"></i> Add Inclusion
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- EXCLUSIONS -->
                    <div class="col-md-6">
                      <div class="exclusions-card">
                        <div class="inc-exc-header exclusions-header">
                          <i class="bi bi-x-circle-fill me-2"></i>
                          <span>Exclusions</span>
                        </div>
                        <div class="inc-exc-body" formArrayName="exclusions">
                          <div
                            class="inc-exc-item"
                            *ngFor="let ex of getExclusions(i).controls; let ei = index"
                          >
                            <input
                              class="form-control"
                              [formControlName]="ei"
                              placeholder="e.g., Personal expenses"
                            />
                            <button
                              class="btn-remove-small"
                              type="button"
                              (click)="removeExclusion(i, ei)"
                            >
                              <i class="bi bi-x-lg"></i>
                            </button>
                          </div>
                          <button
                            class="btn-add-inc-exc"
                            type="button"
                            (click)="addExclusion(i)"
                          >
                            <i class="bi bi-plus me-1"></i> Add Exclusion
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- ITINERARY -->
                  <div class="itinerary-section">
                    <h4 class="itinerary-title">
                      <i class="bi bi-map me-2"></i>
                      Day-wise Itinerary
                    </h4>
                    <div class="itinerary-wrapper" formArrayName="itineraryDays">
                      <div
                        class="itinerary-day-card"
                        *ngFor="let day of getItineraryDays(i).controls; let di = index"
                        [formGroupName]="di"
                      >
                        <div class="day-header">
                          <span class="day-badge">Day {{ di + 1 }}</span>
                          <button
                            type="button"
                            class="btn-remove-day"
                            (click)="removeItineraryDay(i, di)"
                          >
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>

                        <div class="day-body">
                          <input
                            class="form-control day-title-input"
                            formControlName="title"
                            placeholder="e.g., Bangalore to Kotagiri (Via Hosur)"
                          />

                          <div class="activities-section" formArrayName="activities">
                            <div
                              class="activity-item"
                              *ngFor="let act of getActivities(i, di).controls; let ai = index"
                              [formGroupName]="ai"
                            >
                              <div class="activity-time">
                                <i class="bi bi-clock me-2"></i>
                                <input
                                  type="time"
                                  class="form-control time-input"
                                  formControlName="activityTime"
                                />
                              </div>
                              <div class="activity-text">
                                <input
                                  class="form-control"
                                  formControlName="activityText"
                                  placeholder="e.g., Pick-up from BMC, Indiranagar"
                                />
                              </div>
                              <button
                                type="button"
                                class="btn-remove-activity"
                                (click)="removeActivity(i, di, ai)"
                              >
                                <i class="bi bi-trash"></i>
                              </button>
                            </div>
                            <button
                              type="button"
                              class="btn-add-activity"
                              (click)="addActivity(i, di)"
                            >
                              <i class="bi bi-plus-circle me-2"></i> Add Activity
                            </button>
                          </div>
                        </div>
                      </div>

                      <button
                        type="button"
                        class="btn-add-day"
                        (click)="addItineraryDay(i)"
                      >
                        <i class="bi bi-plus-circle me-2"></i> Add Day
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <button
              type="button"
              class="btn-add-batch"
              (click)="addBatch()"
            >
              <i class="bi bi-plus-circle me-2"></i> Add New Batch
            </button>
          </div>
        </div>

        <!-- THINGS TO CARRY -->
        <div class="section-card">
          <div class="section-header">
            <i class="bi bi-backpack-fill me-2"></i>
            <span>Things to Carry</span>
          </div>
          <div class="section-body">
            <div class="things-to-carry-section" formArrayName="thingsToCarry">
              <div class="carry-item" *ngFor="let item of thingsToCarry.controls; let i = index">
                <input
                  class="form-control"
                  [formControlName]="i"
                  placeholder="e.g., Trekking shoes with good grip"
                />
                <button
                  class="btn-remove"
                  type="button"
                  (click)="removeCarryItem(i)"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </div>
              <button
                class="btn-add-item"
                type="button"
                (click)="addCarryItem()"
              >
                <i class="bi bi-plus-circle me-2"></i> Add Item
              </button>
            </div>
          </div>
        </div>

        <!-- IMPORTANT NOTES -->
        <div class="section-card">
          <div class="section-header">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span>Important Notes</span>
          </div>
          <div class="section-body">
            <div class="important-notes-section" formArrayName="importantNotes">
              <div class="note-item" *ngFor="let note of importantNotes.controls; let i = index">
                <input
                  class="form-control"
                  [formControlName]="i"
                  placeholder="e.g., Minimum age: 16 years"
                />
                <button
                  class="btn-remove"
                  type="button"
                  (click)="removeNote(i)"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </div>
              <button
                class="btn-add-item"
                type="button"
                (click)="addNote()"
              >
                <i class="bi bi-plus-circle me-2"></i> Add Note
              </button>
            </div>
          </div>
        </div>

        <!-- IMAGES -->
        <div class="section-card">
          <div class="section-header">
            <i class="bi bi-images me-2"></i>
            <span>Images</span>
            <span class="badge-info ms-auto">PNG / JPG supported</span>
          </div>
          <div class="section-body">
            <!-- COVER IMAGE -->
            <div class="image-upload-section">
              <h4 class="upload-title">
                Cover Image <span class="required">*</span>
              </h4>
              <div class="upload-buttons">
                <button
                  type="button"
                  class="btn-upload primary"
                  (click)="coverGalleryInput.click()"
                >
                  <i class="bi bi-images me-2"></i> Choose from Gallery
                </button>
                <button
                  type="button"
                  class="btn-upload secondary"
                  (click)="coverCameraInput.click()"
                >
                  <i class="bi bi-camera me-2"></i> Take Photo
                </button>
              </div>

              <input
                type="file"
                #coverGalleryInput
                accept="image/*"
                hidden
                (change)="onCoverImageSelect($event)"
              />
              <input
                type="file"
                #coverCameraInput
                accept="image/*"
                capture="environment"
                hidden
                (change)="onCoverImageSelect($event)"
              />

              <div *ngIf="coverPreview" class="image-preview-card cover-preview">
                <img [src]="coverPreview" alt="Cover" />
                <button
                  type="button"
                  class="btn-remove-image"
                  (click)="removeCoverImage()"
                >
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
            </div>

            <div class="divider"></div>

            <!-- GALLERY IMAGES -->
            <div class="image-upload-section">
              <h4 class="upload-title">Gallery Images</h4>
              <div class="upload-buttons">
                <button
                  type="button"
                  class="btn-upload primary"
                  (click)="galleryGalleryInput.click()"
                >
                  <i class="bi bi-images me-2"></i> Choose from Gallery
                </button>
                <button
                  type="button"
                  class="btn-upload secondary"
                  (click)="galleryCameraInput.click()"
                >
                  <i class="bi bi-camera me-2"></i> Take Photo
                </button>
              </div>

              <input
                type="file"
                #galleryGalleryInput
                accept="image/*"
                multiple
                hidden
                (change)="onGallerySelect($event)"
              />
              <input
                type="file"
                #galleryCameraInput
                accept="image/*"
                capture="environment"
                hidden
                (change)="onGallerySelect($event)"
              />

              <div class="gallery-grid" *ngIf="existingGalleryFilenames.length || galleryPreviews.length">
                <!-- Existing images -->
                <div
                  class="gallery-item"
                  *ngFor="let filename of existingGalleryFilenames; let i = index"
                >
                  <img [src]="getGalleryPreviewUrl(filename)" alt="Gallery image" />
                  <button
                    type="button"
                    class="btn-remove-image"
                    (click)="removeGalleryImage(i, true)"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </div>

                <!-- New images -->
                <div
                  class="gallery-item"
                  *ngFor="let img of galleryPreviews; let i = index"
                >
                  <img [src]="img" alt="Gallery image" />
                  <button
                    type="button"
                    class="btn-remove-image"
                    (click)="removeGalleryImage(i, false)"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>

              <div *ngIf="!existingGalleryFilenames.length && !galleryPreviews.length" class="empty-state">
                <i class="bi bi-images"></i>
                <p>No gallery images added yet</p>
              </div>
            </div>
          </div>
        </div>

        <!-- SUBMIT BUTTON -->
        <div class="submit-section">
          <button
            class="btn-publish"
            (click)="updateTrek()"
            [disabled]="editTrekForm.invalid"
          >
            <i class="bi bi-check-circle me-2"></i> Update Trek
          </button>
        </div>
      </form>
    </div>
  </div>
</ion-content>
